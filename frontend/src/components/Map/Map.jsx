import React, { useRef, useEffect, useState } from 'react';
import mapboxgl from 'mapbox-gl';
import { connect } from 'react-redux';
import "./index.css"
import 'mapbox-gl/dist/mapbox-gl.css'

function mapStateToPropsLegend(state) {
  return {
    active: state.active
  };
}

function mapStateToPropsOptionsfield(state) {
  return {
    options: state.options,
    active: state.active
  };
}

mapboxgl.accessToken =
  'pk.eyJ1IjoiZ3VuZG9tMTIzIiwiYSI6ImNsampvYTV3ajA5ejgzcHRndG01MnlzN3EifQ.WS2XL21teWkYAGG36cNN8g';

const Map = props => {
  const mapContainerRef = useRef(null);
  const [map, setMap] = useState(null);
  const [lng, setLng] = useState(-33.87614042626492);
  const [lat, setLat] = useState(151.2394858633264);
  const [zoom, setZoom] = useState(9);

  // Initialize map when component mounts
  useEffect(() => {
    const map = new mapboxgl.Map({
      container: mapContainerRef.current,
      style: 'mapbox://styles/mapbox/light-v11',
      center: [lat, lng],
      zoom: 14
    });
    
    const geojson = {
        'type': 'FeatureCollection',
        'features': [
        {
        'type': 'Feature',
        'properties': {},
        'geometry': {
        'coordinates': [
          [151.22585,-33.8766],
          [151.22564,-33.87659],
          [151.22549,-33.87659],
          [151.22535,-33.87658],
          [151.22496,-33.87658],
          [151.22466,-33.87657],
          [151.2246,-33.87657],
          [151.2245,-33.87655],
          [151.22446,-33.87655],
          [151.22434,-33.87652],
          [151.22436,-33.87646],
          [151.22439,-33.87641],
          [151.22441,-33.87632],
          [151.2244,-33.87608],
          [151.2244,-33.876],
          [151.2244,-33.87599],
          [151.22439,-33.87599],
          [151.22438,-33.87599],
          [151.22438,-33.87598],
          [151.22437,-33.87598],
          [151.22437,-33.87597],
          [151.22437,-33.87596],
          [151.22436,-33.87596],
          [151.22436,-33.87595],
          [151.22436,-33.87594],
          [151.22436,-33.87593],
          [151.22437,-33.87592],
          [151.22437,-33.87591],
          [151.22438,-33.87591],
          [151.22438,-33.8759],
          [151.22439,-33.8759],
          [151.2244,-33.8759],
          [151.2244,-33.87589],
          [151.22441,-33.87589],
          [151.22442,-33.87589],
          [151.22443,-33.87589],
          [151.22444,-33.87589],
          [151.22445,-33.87589],
          [151.22446,-33.87589],
          [151.22446,-33.8759],
          [151.22447,-33.8759],
          [151.22448,-33.87591],
          [151.22449,-33.87592],
          [151.22449,-33.87593],
          [151.22449,-33.87594],
          [151.2245,-33.87594],
          [151.2245,-33.87595],
          [151.22449,-33.87595],
          [151.22449,-33.87596],
          [151.22449,-33.87597],
          [151.22448,-33.87598],
          [151.22447,-33.87598],
          [151.22447,-33.87599],
          [151.22446,-33.87599],
          [151.22446,-33.87608],
          [151.22446,-33.8762],
          [151.22453,-33.87623],
          [151.22454,-33.87623],
          [151.22456,-33.87624],
          [151.22478,-33.87627],
          [151.22503,-33.8763],
          [151.22534,-33.87633],
          [151.22568,-33.87635],
          [151.22581,-33.87636],
          [151.22623,-33.87638],
          [151.22654,-33.87638],
          [151.22657,-33.87638],
          [151.22659,-33.87637],
          [151.2266,-33.87637],
          [151.22663,-33.87633],
          [151.2268,-33.87633],
          [151.22704,-33.87632],
          [151.22718,-33.87632],
          [151.22742,-33.87631],
          [151.22744,-33.8763],
          [151.22749,-33.87628],
          [151.22761,-33.87627],
          [151.22774,-33.87626],
          [151.22787,-33.87626],
          [151.22802,-33.87625],
          [151.22838,-33.87622],
          [151.22852,-33.87621],
          [151.22861,-33.87621],
          [151.22873,-33.87622],
          [151.22883,-33.87623],
          [151.22886,-33.87623],
          [151.22897,-33.87625],
          [151.22926,-33.8763],
          [151.22934,-33.87631],
          [151.2295,-33.87634],
          [151.22964,-33.87637],
          [151.22971,-33.87637],
          [151.22984,-33.87639],
          [151.23,-33.87642],
          [151.23032,-33.87646],
          [151.23068,-33.87651],
          [151.23147,-33.87664],
          [151.23168,-33.87667],
          [151.23183,-33.87671],
          [151.23195,-33.87676],
          [151.23203,-33.87677],
          [151.2321,-33.87679],
          [151.2322,-33.87681],
          [151.23228,-33.87682],
          [151.23235,-33.87684],
          [151.23264,-33.8769],
          [151.23277,-33.87693],
          [151.23313,-33.87701],
          [151.23322,-33.87703],
          [151.23325,-33.87704],
          [151.23332,-33.87706],
          [151.23336,-33.87708],
          [151.23342,-33.87711],
          [151.23353,-33.87717],
          [151.23369,-33.87727],
          [151.23378,-33.87734],
          [151.234,-33.87751],
          [151.23402,-33.87753],
          [151.23426,-33.87772],
          [151.23427,-33.87773],
          [151.23436,-33.87782],
          [151.23446,-33.87791],
          [151.23461,-33.87806],
          [151.23486,-33.87831],
          [151.23491,-33.87837],
          [151.23496,-33.87842],
          [151.23503,-33.87847],
          [151.23508,-33.87851],
          [151.23512,-33.87854],
          [151.23516,-33.87856],
          [151.23531,-33.8786],
          [151.23579,-33.87869],
          [151.23596,-33.87873],
          [151.23618,-33.87877],
          [151.23648,-33.87883],
          [151.23701,-33.87893],
          [151.23753,-33.87902],
          [151.23761,-33.87903],
          [151.23781,-33.87905],
          [151.2379,-33.87907],
          [151.23795,-33.87908],
          [151.23799,-33.87909],
          [151.23804,-33.8791],
          [151.23808,-33.87912],
          [151.2381,-33.87913],
          [151.23811,-33.87914],
          [151.23813,-33.87916],
          [151.23823,-33.87919],
          [151.23837,-33.87925],
          [151.23843,-33.87927],
          [151.23845,-33.87927],
          [151.23848,-33.87927],
          [151.23851,-33.87927],
          [151.23854,-33.87926],
          [151.23856,-33.87926],
          [151.2386,-33.87925],
          [151.23864,-33.87923],
          [151.23876,-33.87918],
          [151.23896,-33.8791],
          [151.2391,-33.87904],
          [151.23916,-33.87902],
          [151.23918,-33.87901],
          [151.23922,-33.87899],
          [151.23925,-33.87897],
          [151.2393,-33.87894],
          [151.23948,-33.87881],
          [151.23959,-33.87877],
          [151.23969,-33.87873],
          [151.23976,-33.87871],
          [151.23983,-33.87869],
          [151.23984,-33.87869],
          [151.24003,-33.87865],
          [151.2401,-33.87864],
          [151.24022,-33.87862],
          [151.2404,-33.87859],
          [151.24046,-33.87858],
          [151.24056,-33.87856],
          [151.24078,-33.87853],
          [151.24084,-33.87852],
          [151.24097,-33.8785],
          [151.24107,-33.87849],
          [151.24116,-33.87849],
          [151.24121,-33.87849],
          [151.24123,-33.87849],
          [151.24128,-33.87849],
          [151.24135,-33.8785],
          [151.24159,-33.87853],
          [151.2417,-33.87855],
          [151.24175,-33.87855],
          [151.24178,-33.87855],
          [151.24181,-33.87855],
          [151.24189,-33.87854],
          [151.24196,-33.87852],
          [151.24198,-33.87851],
          [151.24201,-33.8785],
          [151.24205,-33.87848],
          [151.24215,-33.87844],
          [151.2422,-33.87841],
          [151.24223,-33.87839],
          [151.24226,-33.87836],
          [151.2423,-33.87833],
          [151.24233,-33.87829],
          [151.24236,-33.87827],
          [151.24237,-33.87825],
          [151.24239,-33.87822],
          [151.24244,-33.87817],
          [151.24248,-33.87813],
          [151.24253,-33.87808],
          [151.24257,-33.87802],
          [151.24262,-33.87798],
          [151.24263,-33.87797],
          [151.24266,-33.87793],
          [151.2427,-33.87789],
          [151.24275,-33.87785],
          [151.24279,-33.87782],
          [151.24285,-33.87778],
          [151.24289,-33.87775],
          [151.24297,-33.87771],
          [151.24301,-33.87769],
          [151.24305,-33.87767],
          [151.24313,-33.87764],
          [151.24347,-33.8775],
          [151.2435,-33.87748],
          [151.24353,-33.87746],
          [151.2436,-33.87744],
          [151.24365,-33.87742],
          [151.2437,-33.87741],
          [151.24382,-33.87738],
          [151.24399,-33.87735],
          [151.24441,-33.87726],
          [151.24451,-33.87724],
          [151.24462,-33.87717],
          [151.24472,-33.87715],
          [151.24478,-33.87712],
          [151.24482,-33.8771],
          [151.24492,-33.87714],
          [151.2452,-33.87735],
          [151.24596,-33.8779],
          [151.24603,-33.87795],
          [151.24633,-33.87814],
          [151.2464,-33.8782],
          [151.2466,-33.87833],
          [151.24669,-33.87839],
          [151.24684,-33.87849],
          [151.24717,-33.87871],
          [151.24728,-33.87879],
          [151.2474,-33.87886],
          [151.24811,-33.87929],
          [151.24814,-33.87931],
          [151.24822,-33.87935],
          [151.24827,-33.87939],
          [151.24829,-33.8794],
          [151.2483,-33.87941],
          [151.24833,-33.87944],
          [151.24835,-33.87946],
          [151.24835,-33.87947],
          [151.24838,-33.87951],
          [151.24842,-33.87957],
          [151.24845,-33.87963],
          [151.24847,-33.87968],
          [151.24849,-33.87973],
          [151.24854,-33.87992],
          [151.24856,-33.88001],
          [151.24858,-33.88007],
          [151.2486,-33.88011],
          [151.24861,-33.88015],
          [151.24865,-33.88021],
          [151.24869,-33.88028],
          [151.24872,-33.88033],
          [151.24876,-33.88037],
          [151.24879,-33.88039],
          [151.24883,-33.88041],
          [151.24889,-33.88045],
          [151.24897,-33.8805],
          [151.24904,-33.88054],
          [151.24914,-33.88057],
          [151.24929,-33.88063],
          [151.24956,-33.88072],
          [151.25,-33.88084],
          [151.25021,-33.88091],
          [151.25025,-33.88092],
          [151.25027,-33.88093],
          [151.2503,-33.88095],
          [151.25032,-33.88096],
          [151.25034,-33.88099],
          [151.25036,-33.88102],
          [151.25039,-33.88106],
          [151.25041,-33.88111],
          [151.25048,-33.88122],
          [151.25052,-33.88131],
          [151.25057,-33.88141],
          [151.25076,-33.88187],
          [151.25078,-33.88192],
          [151.2508,-33.88195],
          [151.25081,-33.88197],
          [151.25083,-33.88198],
          [151.25085,-33.882],
          [151.25086,-33.88201],
          [151.25089,-33.88203],
          [151.25094,-33.88204],
          [151.25098,-33.88204],
          [151.251,-33.88205],
          [151.25102,-33.88205],
          [151.25106,-33.88207],
          [151.25108,-33.88207],
          [151.2511,-33.88207],
          [151.25117,-33.88208],
          [151.25123,-33.88209],
          [151.25123,-33.88208],
          [151.25124,-33.88208],
          [151.25125,-33.88207],
          [151.25126,-33.88207],
          [151.25127,-33.88207],
          [151.25128,-33.88207],
          [151.25128,-33.88206],
          [151.25129,-33.88206],
          [151.2513,-33.88207],
          [151.25131,-33.88207],
          [151.25132,-33.88207],
          [151.25133,-33.88207],
          [151.25133,-33.88208],
          [151.25134,-33.88208],
          [151.25135,-33.88208],
          [151.25135,-33.88209],
          [151.25136,-33.88209],
          [151.25164,-33.88216],
          [151.25192,-33.8822],
          [151.25204,-33.88222],
          [151.25209,-33.88224],
          [151.25214,-33.88225],
          [151.2522,-33.88227],
          [151.25226,-33.88229],
          [151.25268,-33.88154],
          [151.25307,-33.88158],
          [151.25374,-33.88221],
          [151.25438,-33.88172],
          [151.25477,-33.88142],
          [151.25524,-33.88106],
          [151.25579,-33.88066],
          [151.2561,-33.88042],
          [151.25619,-33.88034],
          [151.25608,-33.88029],
          [151.25603,-33.88026],
          [151.25592,-33.88022],
          [151.25577,-33.88017],
          [151.25569,-33.88015],
          [151.25555,-33.88011],
          [151.2555,-33.8801],
          [151.25546,-33.88008],
          [151.25537,-33.88004],
          [151.2552,-33.87991],
          [151.25488,-33.87961],
          [151.25417,-33.87892],
          [151.25406,-33.8788],
          [151.25402,-33.87877],
          [151.25375,-33.87851],
          [151.25365,-33.87842],
          [151.25339,-33.87819],
          [151.2533,-33.87811],
          [151.25322,-33.87801],
          [151.25306,-33.87778],
          [151.25304,-33.87774],
          [151.25302,-33.87769],
          [151.25299,-33.87762],
          [151.25289,-33.8773],
          [151.25289,-33.87721],
          [151.25288,-33.8771],
          [151.25291,-33.87696],
          [151.25295,-33.87679],
          [151.25301,-33.87655],
          [151.25307,-33.8763],
          [151.25309,-33.87624],
          [151.25312,-33.87611],
          [151.25313,-33.87602],
          [151.25314,-33.876],
          [151.25313,-33.87598],
          [151.25311,-33.87593],
          [151.25306,-33.87578],
          [151.25318,-33.87577],
          [151.25324,-33.87578],
          [151.25328,-33.87579],
          [151.25333,-33.87581],
          [151.25336,-33.87582],
          [151.25341,-33.87586],
          [151.25352,-33.87593],
          [151.25361,-33.87601],
          [151.25364,-33.87607],
          [151.25367,-33.8761],
          [151.25382,-33.87646],
          [151.25385,-33.87652],
          [151.25388,-33.87655],
          [151.25392,-33.8766],
          [151.25395,-33.87663],
          [151.25398,-33.87665],
          [151.25407,-33.87671],
          [151.25411,-33.87673],
          [151.25418,-33.87675],
          [151.25422,-33.87676],
          [151.25429,-33.87678],
          [151.25436,-33.87678],
          [151.25441,-33.87678],
          [151.25449,-33.87678],
          [151.25457,-33.87676],
          [151.25464,-33.87674],
          [151.25469,-33.87672],
          [151.25475,-33.87668],
          [151.25481,-33.87663],
          [151.25487,-33.87656],
          [151.25493,-33.87649],
          [151.25496,-33.87644],
          [151.25499,-33.87639],
          [151.25544,-33.87517],
          [151.25547,-33.8751],
          [151.25549,-33.87504],
          [151.2555,-33.87499],
          [151.25549,-33.87488],
          [151.25546,-33.87466],
          [151.25539,-33.87419],
          [151.25538,-33.87414],
          [151.25531,-33.87373],
          [151.25526,-33.87343],
          [151.25525,-33.87339],
          [151.25523,-33.87331],
          [151.2552,-33.87323],
          [151.25505,-33.87294],
          [151.25474,-33.87227],
          [151.25473,-33.87223],
          [151.25472,-33.87219],
          [151.25473,-33.87214]
        ],
        'type': 'LineString'
        }
        }
        ]
        };

    map.on('load', () => {
      map.addSource('line', {
        type: 'geojson',
        data: geojson
      });

      map.setPaintProperty("water", 'fill-color', "#cce3f9");
        
      // add a line layer without line-dasharray defined to fill the gaps in the dashed line
      map.addLayer({
        type: 'line',
        source: 'line',
        id: 'line-background',
        paint: {
          'line-color': '#f39a0c',
          'line-width': 10,
          'line-opacity': 0.4
        }
      });
        
      // add a line layer with line-dasharray set to the first value in dashArraySequence
      map.addLayer({
        type: 'line',
        source: 'line',
        id: 'line-dashed',
        paint: {
          'line-color': '#f39a0c',
          'line-width': 10,
          'line-dasharray': [0, 4, 3]
        }
      });
        
      // technique based on https://jsfiddle.net/2mws8y3q/
      // an array of valid line-dasharray values, specifying the lengths of the alternating dashes and gaps that form the dash pattern
      const dashArraySequence = [
        [0, 4, 3],
        [0.5, 4, 2.5],
        [1, 4, 2],
        [1.5, 4, 1.5],
        [2, 4, 1],
        [2.5, 4, 0.5],
        [3, 4, 0],
        [0, 0.5, 3, 3.5],
        [0, 1, 3, 3],
        [0, 1.5, 3, 2.5],
        [0, 2, 3, 2],
        [0, 2.5, 3, 1.5],
        [0, 3, 3, 1],
        [0, 3.5, 3, 0.5]
      ];
        
      let step = 0;
        
      function animateDashArray(timestamp) {
      // Update line-dasharray using the next value in dashArraySequence. The
      // divisor in the expression `timestamp / 50` controls the animation speed.
        const newStep = parseInt(
          (timestamp / 50) % dashArraySequence.length
        );
        
        if (newStep !== step) {
          map.setPaintProperty(
            'line-dashed',
            'line-dasharray',
            dashArraySequence[step]
          );
          step = newStep;
        }
          
        // Request the next frame of the animation.
        requestAnimationFrame(animateDashArray);
      }
        
      // start the animation
      animateDashArray(0);
    });

    map.on('move', () => {
      setLng(map.getCenter().lng.toFixed(4));
      setLat(map.getCenter().lat.toFixed(4));
      setZoom(map.getZoom().toFixed(2));
    });

    // Clean up on unmount
    return () => map.remove();
  }, []);

  return (
    <div>
      <div className="sidebar">
        Longitude: {lng} | Latitude: {lat} | Zoom: {zoom}
      </div>
      <div ref={mapContainerRef} className='map-container' />
    </div>
  );
};

export default Map;